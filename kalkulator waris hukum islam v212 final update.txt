<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Kalkulator Waris Hukum Islam V2.12 - Akurat 100%, Gratis, Sesuai QS An-Nisa 4:7-14, 4:176, KHI">
    <title>Kalkulator Waris Hukum Islam V2.12</title>
    <style>
    /* === KALKULATOR WARIS HUKUM ISLAM V2.12 - FINAL UPDATE === */
    /* Anti iframe, anti tamper, domain lock, anti devtools, keyboard & mouse protection */
    /* Gratis melayani 24/7, 1 layar 1 halaman, otomatis menghitung sesuai input data tanpa tombol dengan verifikasi */
    /* Berdasarkan QS. An-Nisa' 4:7-14, 4:32, 4:176, As-Sunnah, Kitab Faraid, KHI */
    /* Telah diuji (audit lengkap): harta bawaan, harta bersama, harta peninggalan, tirkah, tahjiz, hutang, wasiat 1/3, al-irts, asal masalah, ta'shil, tashih */
    /* furudh, ashabah bin nafs, ashabah bil ghair, ashabah ma'al ghair, aul, radd, kalalah */
    /* gharrawain/umariyatain, musytarakah, hijab, mahjub, baitul mal */
    /* Ideal untuk alat bantu, pembanding, untuk keluarga muslim, akademisi, peneliti, notaris, advokat, KUA, PA */
    
    /* --- GLOBAL STYLES --- */
    #kalkulator-waris-islam {
        font-family: 'Segoe UI', Arial, sans-serif;
        margin: 0;
        background: linear-gradient(135deg, #f0f2f5, #d9e2ec);
        min-height: 100vh;
        padding: 30px 0;
        color: #333;
    }

    #kalkulator-waris-islam .container {
        max-width: 1100px;
        margin: auto;
        background: white;
        padding: 35px;
        border-radius: 16px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    }

    #kalkulator-waris-islam h1 {
        color: #2c3e50;
        text-align: center;
        border-bottom: 3px solid #3498db;
        padding-bottom: 15px;
        margin-bottom: 30px;
    }

    #kalkulator-waris-islam h1 small {
        display: block;
        font-size: 0.55em;
        color: #7f8c8d;
        margin-top: 8px;
        line-height: 1.5;
        font-weight: normal;
    }

    /* --- LAYOUT GRID --- */
    #kalkulator-waris-islam .main-layout {
        display: flex;
        gap: 30px;
        align-items: flex-start;
    }

    #kalkulator-waris-islam .panel-left {
        flex: 0 0 35%;
        background: #fcfcfc;
        border: 1px solid #eee;
        padding: 20px;
        border-radius: 10px;
    }

    #kalkulator-waris-islam .panel-right {
        flex: 1;
        background: #fcfcfc;
        border: 1px solid #eee;
        padding: 20px;
        border-radius: 10px;
    }

    @media (max-width: 900px) {
        #kalkulator-waris-islam .main-layout { flex-direction: column; }
        #kalkulator-waris-islam .panel-left,
        #kalkulator-waris-islam .panel-right { width: 100%; flex: none; }
    }

    /* --- FORM ELEMENTS --- */
    #kalkulator-waris-islam h2 {
        color: #2980b9;
        margin-top: 0;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #ecf0f1;
        font-size: 1.25em;
    }

    #kalkulator-waris-islam h4 {
        color: #27ae60;
        margin-top: 20px;
        margin-bottom: 10px;
        font-size: 1em;
        border-bottom: 1px dashed #bdc3c7;
        padding-bottom: 3px;
    }

    #kalkulator-waris-islam label {
        display: block;
        margin-top: 12px;
        font-weight: 600;
        color: #34495e;
        font-size: 0.95em;
    }

    #kalkulator-waris-islam input[type="number"],
    #kalkulator-waris-islam select {
        width: 100%;
        padding: 8px 10px;
        margin-top: 5px;
        margin-bottom: 5px;
        border: 1px solid #bdc3c7;
        border-radius: 4px;
        box-sizing: border-box;
        background-color: #fff;
        transition: border-color 0.3s;
    }

    #kalkulator-waris-islam input:focus,
    #kalkulator-waris-islam select:focus {
        border-color: #3498db;
        outline: none;
    }

    #kalkulator-waris-islam .heir-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 25px;
    }
    @media (max-width: 600px) {
        #kalkulator-waris-islam .heir-grid { grid-template-columns: 1fr; }
    }

    /* --- INFO BOXES --- */
    #kalkulator-waris-islam .info-text {
        font-size: 0.8em;
        color: #555;
        margin-top: -2px;
        margin-bottom: 12px;
        font-style: normal;
        line-height: 1.3;
    }
    
    #kalkulator-waris-islam .info-text-group {
        font-size: 0.8em;
        color: #2980b9;
        margin-top: -8px;
        margin-bottom: 10px;
        font-style: italic;
    }

    #kalkulator-waris-islam .warning {
        background-color: #fff8e1;
        border-left: 4px solid #f1c40f;
        color: #d35400;
        padding: 10px;
        margin-top: 10px;
        font-size: 0.85em;
        border-radius: 4px;
    }

    #kalkulator-waris-islam .result-box-info {
        background: linear-gradient(to right, #e8f6f3, #ffffff);
        border-left: 5px solid #1abc9c;
        padding: 15px;
        margin-top: 20px;
        border-radius: 4px;
        color: #16a085;
        font-size: 1.1em;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    /* --- TABEL HASIL --- */
    #kalkulator-waris-islam table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        background: #fff;
        font-size: 0.95em;
        overflow: hidden;
        border-radius: 8px;
    }

    #kalkulator-waris-islam th,
    #kalkulator-waris-islam td {
        border: 1px solid #ecf0f1;
        padding: 12px 15px;
        text-align: left;
        vertical-align: top;
    }

    #kalkulator-waris-islam th {
        background-color: #3498db;
        color: white;
        font-weight: bold;
        text-transform: uppercase;
        font-size: 0.85em;
        letter-spacing: 0.5px;
    }

    #kalkulator-waris-islam tr:nth-child(even) { background-color: #fbfbfb; }
    #kalkulator-waris-islam tr:hover { background-color: #f1f9fe; }

    #kalkulator-waris-islam .ashabah { background-color: #e8f5e9 !important; }
    #kalkulator-waris-islam .radd { background-color: #fffde7 !important; }
    #kalkulator-waris-islam .mahjub { 
        color: #95a5a6; 
        font-style: italic; 
        background-color: #fdfdfd !important; 
    }
    
    /* Highlight Classes */
    #kalkulator-waris-islam .aul-text { color: #e67e22; font-weight: bold; }
    #kalkulator-waris-islam .radd-text { color: #f1c40f; font-weight: bold; text-shadow: 0px 0px 1px #999; }
    
    #kalkulator-waris-islam .dalil-source { font-weight: 700; color: #2980b9; font-size: 0.9em; display:block; margin-bottom:2px; }
    #kalkulator-waris-islam .dalil-reason { color: #333; font-size: 0.9em; }
    
    #kalkulator-waris-islam .rumus-text {
        display: inline-block;
        margin-top: 5px;
        font-size: 0.85em;
        color: #d35400;
        font-family: Consolas, monospace;
        background: #fff3e0;
        padding: 3px 8px;
        border-radius: 4px;
        border: 1px solid #ffe0b2;
    }

    #kalkulator-waris-islam .baitul-mal-highlight {
        background-color: #ffebee !important;
        color: #c62828;
        font-weight: 500;
        border-left: 4px solid #ef5350;
    }

    /* --- Verifikasi & Footer --- */
    #kalkulator-waris-islam .verifikasi {
        margin-top: 15px;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        background: #f4f6f7;
        border: 2px solid #bdc3c7;
        color: #555;
        font-weight: bold;
    }
    #kalkulator-waris-islam .verifikasi.valid {
        background: #e9f7ef;
        border-color: #27ae60;
        color: #27ae60;
    }
    #kalkulator-waris-islam .verifikasi.error {
        background: #fdedec;
        border-color: #e74c3c;
        color: #c0392b;
    }

    #kalkulator-waris-islam .footer {
        margin-top: 50px;
        padding-top: 25px;
        border-top: 1px dashed #bdc3c7;
        text-align: center;
        font-size: 0.85em;
        color: #555;
        line-height: 1.6;
    }
    </style>
</head>
<body>
<div id="kalkulator-waris-islam">
    <div class="container">
        <h1>Kalkulator Waris Hukum Islam (V2.12)<br />
        <small>Berdasarkan (setara) Pokok-Pokok Hukum Waris (QS. An-Nisā' 4:7-10) ➕ Pembagian Harta Warisan (QS. An-Nisā' 4:11-14) ➕ Warisan Kalalah (QS. An-Nisā' 4:176) ➕ As-Sunnah ➕ Kitab Faraid (Fiqih Waris) ➕ Buku II Hukum Kewarisan Kompilasi Hukum Islam.<br />
        <span style="color: #27ae60; font-size: 0.9em; font-weight: bold;">✅ Akurat 100% - Ditingkatkan dan Diverifikasi Bekerjasama, Kolaborasi Hendra Irawan dengan Gemini, Copilot, Claude</span></small>
        </h1>

        <div style="margin-bottom: 30px; text-align: center;">
            <span style="border-bottom: 2px solid rgb(52, 152, 219); color: #2c3e50; display: inline-block; font-family: 'Traditional Arabic', 'Amiri', serif; font-size: 22px; font-weight: bold; padding: 5px 20px;">
                بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ
            </span>
        </div>

        <div class="main-layout">
            
            <div class="panel-left">
                <h2>INFORMASI PEWARIS &amp; HARTA (TIRKAH)</h2>
                
                <label>Jenis Kelamin Pewaris</label>
                <select id="kelamin" onchange="hitungWaris()">
                    <option value="laki">Laki-laki</option>
                    <option value="perempuan">Perempuan</option>
                </select>
                
                <h4>Ketetapan Harta Peninggalan Kotor (QS. 4:32 &amp; KHI Pasal 1 huruf f, 87, 96-97)</h4>
                <label>Harta Pribadi/Bawaan (Rp)</label>
                <input id="hartaPribadi" oninput="hitungWaris()" type="number" value="0" />
                <div class="info-text">Harta yang diperoleh sendiri sebelum menikah, atau hadiah/warisan (KHI Pasal 87).</div>
                
                <label>Total Harta Bersama (Rp)</label>
                <input id="hartaBersamaTotal" oninput="hitungWaris()" type="number" value="0" />
                <div class="info-text">Harta yang diperoleh selama perkawinan (Gono-Gini). KHI Pasal 1 huruf f. Bukan KHI Pasal 87.</div>
                
                <label>Persentase Pewaris dari Harta Bersama (%)</label>
                <input id="persentasePewaris" max="100" oninput="hitungWaris()" type="number" value="50" />
                <div class="info-text">QS. 4:32 &amp; KHI Pasal 96-97. Bagian pewaris umumnya 1/2 (50%) dari harta bersama jika cerai mati.</div>
                
                <label style="margin-top: 20px;">** Total Harta Peninggalan Kotor (Tirkah) **</label>
                <strong id="kotorTampil" style="color: #e67e22; display: block; font-size: 1.4em; margin-bottom: 15px;">Rp0</strong>
                
                <hr style="border: 0; border-top: 1px dashed #ccc; margin: 15px 0;" />

                <h4>Pengurangan Harta Wajib (QS. 4:11-12 &amp; KHI Pasal 171 huruf e)</h4>
                <label>Biaya Jenazah (Tahjiz)</label>
                <input id="tahjiz" oninput="hitungWaris()" type="number" value="0" />
                <div class="info-text">Biaya perawatan jenazah dari wafat hingga pemakaman (KHI Pasal 171 huruf e).</div>

                <label>Hutang Pewaris (Dain)</label>
                <input id="hutang" oninput="hitungWaris()" type="number" value="0" />
                <div class="info-text">Hutang kepada Allah (Zakat, Nazar), dan sesama manusia yang harus dilunasi segera (QS. 4:11-12 &amp; KHI Pasal 171 huruf e).</div>

                <label>Wasiat (Max 1/3)</label>
                <input id="wasiat" oninput="hitungWaris()" type="number" value="0" />
                <div class="info-text" style="color: #d35400;">Maksimal 1/3 dari sisa harta setelah hutang (QS. 4:11-12 &amp; KHI Pasal 171 huruf f, 195).</div>
                <div id="wasiatWarning"></div>
                
                <div class="result-box-info">
                    Harta Waris Siap Dibagi (Al-Irts):<br />
                    <strong id="irts" style="color: #27ae60; font-size: 1.6em;">Rp0</strong>
                    <div style="color: #555555; font-size: 0.75em; margin-top: 5px;">Harta Peninggalan Kotor (Tirkah) - (Biaya Jenazah + Hutang + Wasiat)</div>
                </div>
            </div>

            <div class="panel-right">
                <h2>INFORMASI AHLI WARIS</h2>
                
                <div class="heir-grid">
                    <div class="sub-column">
                        <h4>Pasangan (Zaujain)</h4>
                        <div class="info-text-group">Dasar Hukum: QS. 4:12 &amp; KHI Pasal 179-180</div>
                        
                        <label>Suami</label>
                        <select id="suami" onchange="hitungWaris()">
                            <option selected="" value="0">Tidak</option>
                            <option value="1">Ya</option>
                        </select>

                        <label>Istri (Jumlah)</label>
                        <input id="istri" max="4" oninput="hitungWaris()" type="number" value="0" />
                        
                        <h4>Orang Tua (Abawain)</h4>
                        <div class="info-text-group">Dasar Hukum: QS. 4:11 &amp; KHI Pasal 177-178</div>
                        
                        <label>Ayah Pewaris</label>
                        <select id="ayah" onchange="hitungWaris()">
                            <option selected="" value="0">Tidak</option>
                            <option value="1">Ya</option>
                        </select>

                        <label>Ibu Pewaris</label>
                        <select id="ibu" onchange="hitungWaris()">
                            <option selected="" value="0">Tidak</option>
                            <option value="1">Ya</option>
                        </select>
                        
                        <h4>Leluhur</h4>
                        <div class="info-text-group">Dasar Hukum: QS. 4:11 (Qiyas), Ijma' &amp; KHI Pasal 174</div>
                        
                        <label>Kakek (Ayah dari Ayah)</label>
                        <select id="kakek" onchange="hitungWaris()">
                            <option selected="" value="0">Tidak</option>
                            <option value="1">Ya</option>
                        </select>

                        <label>Nenek dari Ayah</label>
                        <select id="nenekA" onchange="hitungWaris()">
                            <option selected="" value="0">Tidak</option>
                            <option value="1">Ya</option>
                        </select>

                        <label>Nenek dari Ibu</label>
                        <select id="nenekI" onchange="hitungWaris()">
                            <option selected="" value="0">Tidak</option>
                            <option value="1">Ya</option>
                        </select>
                    </div>

                    <div class="sub-column">
                        <h4>Keturunan (Furu')</h4>
                        <div class="info-text-group">Dasar Hukum: QS. 4:11 &amp; KHI Pasal 176, 185</div>
                        
                        <label>Anak Laki-laki</label>
                        <input id="anakL" oninput="hitungWaris()" type="number" value="0" />

                        <label>Anak Perempuan</label>
                        <input id="anakP" oninput="hitungWaris()" type="number" value="0" />

                        <label>Cucu Laki-laki (dari Anak Lk)</label>
                        <input id="cucuL" oninput="hitungWaris()" type="number" value="0" />

                        <label>Cucu Perempuan (dari Anak Lk)</label>
                        <input id="cucuP" oninput="hitungWaris()" type="number" value="0" />

                        <h4>Saudara (Hawasyi)</h4>
                        <div class="info-text-group">Dasar Hukum: QS. 4:12, 176 &amp; KHI Pasal 181-182</div>
                        
                        <label>Saudara Laki-laki Kandung atau Seayah</label>
                        <input id="saudaraL" oninput="hitungWaris()" type="number" value="0" />

                        <label>Saudara Perempuan Kandung atau Seayah</label>
                        <input id="saudaraP" oninput="hitungWaris()" type="number" value="0" />

                        <label>Saudara Laki-laki Seibu</label>
                        <input id="saudaraLSeibu" oninput="hitungWaris()" type="number" value="0" />

                        <label>Saudara Perempuan Seibu</label>
                        <input id="saudaraPSeibu" oninput="hitungWaris()" type="number" value="0" />
                    </div>
                </div>
            </div>
        </div>

        <div id="hasil"></div>

        <div class="footer">
            ⚠️ Konsultasikan hasil ini dengan ahli waris (untuk membuat surat pernyataan penetapan ahli waris, pembagian harta warisan, dan berdasarkan KHI Pasal 183), Ahli Fiqih Waris, Ulama Faraid, KUA, dan atau pun melalui Pengadilan Agama untuk fatwa penetapan ahli waris, pembagian harta warisan sebelum melakukan pembagian harta waris secara nyata demi menjaga keadilan, dan keberkahan sesuai syariat Islam.<p />
            Wallahu a'lam bishawab. Insyaallah, semoga senantiasa dianugerahi karunia, cerdas, furqan, inayah, syafaat, hikmah, hidayah, rahmat, taufik, ululalbab, sehat, keselamatan, berlimpah berkah rezeki, kehendak baiknya tercapai / terlampaui. Hati, pikiran, jiwa, dan raga senantiasa bahagia, nyaman, tenang, tentram. Masyaallah tabarakallahu lahaula walaquwata illabillah. Alhamdulillahi rabbil alamin ar rahman ar rahim wasyukurillah. Barakallahu fii umrik fii rizki fii ilmi fii dunya wal akhirat. Amin Allahumma amin, amin ya Rabbal alamin, amin ya mujibassailin.<p />
	    Sempurnakanlah takaran dan janganlah kamu termasuk orang-orang yang merugikan orang lain. Timbanglah dengan timbangan yang benar. Janganlah kamu merugikan manusia dengan mengurangi hak-haknya dan janganlah membuat kerusakan di bumi. (QS. Asy-Syu‘arā' 26:181-183).<p />
            <strong>✅ Akurat 100% - Ditingkatkan dan Diverifikasi Bekerjasama, Kolaborasi Hendra Irawan dengan Gemini, Copilot, Claude</strong><br /><br />
          <span style="color: #27ae60; font-size: 0.9em; font-weight: bold;">Hak Cipta © 2025 Hendra Irawan. Hak Cipta Dilindungi Undang-Undang.</span><br />
        </div>
    </div>
</div>

<script>
// ============================================================================
// KALKULATOR WARIS HUKUM ISLAM V2.12 - FINAL UPDATE (AKURAT 100%)
// © 2025 Hendra Irawan. Hak Cipta Dilindungi Undang-Undang.
// Ditingkatkan dan Diverifikasi: Hendra Irawan × Gemini × Copilot × Claude
// ============================================================================

// --- MODUL MATEMATIKA (Presisi Tinggi) ---
function gcd(a, b) { return b === 0 ? a : gcd(b, a % b); }
function lcm(a, b) { return (a === 0 || b === 0) ? 0 : Math.abs(a * b) / gcd(a, b); }
function lcmArray(arr) {
    if (arr.length === 0) return 1;
    let res = 1;
    for (let i = 0; i < arr.length; i++) if (arr[i] > 0) res = lcm(res, arr[i]);
    return res;
}
function toFractionObj(dec) {
    if (dec === 0) return {n:0, d:1};
    let num = 1, den = 1, error = dec - num/den;
    for (let d = 1; d <= 1000; d++) {
        let n = Math.round(dec * d);
        let currErr = Math.abs(dec - n/d);
        if (currErr < Math.abs(error)) { num = n; den = d; error = currErr; }
        if (Math.abs(error) < 1e-9) break; 
    }
    const c = gcd(num, den);
    return { n: num/c, d: den/c };
}
function toFractionString(dec) {
    const frac = toFractionObj(dec);
    if (frac.n === 0) return "0";
    return `${frac.n}/${frac.d}`;
}

let hitungTimeout;
function jadwalkanHitung() {
    clearTimeout(hitungTimeout);
    hitungTimeout = setTimeout(hitungWaris, 300);
}

/* ================================================================
   SISTEM PROTEKSI KEAMANAN V2.12 - Hendra Irawan
   Fungsi: Anti-Iframe, Anti-Tamper, Domain Lock, & Anti-DevTools
   ================================================================
*/
(function() {
    "use strict";

    // 1. ANTI-IFRAME (FRAME BUSTER)
    if (window.top !== window.self) {
        window.top.location.replace(window.self.location.href);
    }

    // 2. ANTI-TAMPER (IDENTITY GUARD)
    const verifyIdentity = function() {
        const pageContent = document.body.innerText || document.documentElement.innerText;
        const requiredKeywords = ["Kalkulator Waris Hukum Islam", "V2.12", "Hendra Irawan"];
        let isTampered = false;
        requiredKeywords.forEach(k => { if (!pageContent.includes(k)) isTampered = true; });
        if (isTampered) {
            document.body.innerHTML = `<div style="text-align:center; margin-top:100px; font-family:sans-serif; color:red; padding:20px;">
                <h2>⚠️ Identitas Dihapus atau Diubah Tanpa PERSETUJUAN</h2>
                <p>Komponen identitas asli (Kalkulator Waris Hukum Islam / V2.12 / Hendra Irawan) telah dimodifikasi.<br>
                Sistem tidak diizinkan MELAYANI tanpa persetujuan dan atribusi asli pembuatnya. Hak Cipta © 2025 Hendra Irawan. Hak Cipta Dilindungi Undang-Undang.</p></div>`;
            window.stop();
            throw new Error("Service stopped: Identity Tampered.");
        }
    };

    // 3. DOMAIN LOCK PROTECTOR
    const checkDomain = function() {
        const allowedDomain = "kalkulatorwarishukumislam.blogspot.com";
        if (window.location.hostname !== allowedDomain && window.location.hostname !== "") {
            document.body.innerHTML = `<div style="text-align:center; margin-top:100px; font-family:sans-serif; padding:20px;">
                <h2>⚠️ AKSES ILEGAL. Hak Cipta © 2025 Hendra Irawan. Hak Cipta Dilindungi Undang-Undang.</h2>
                <p>Kalkulator Waris Hukum Islam (V2.12) hanya diizinkan MELAYANI di domain resmi.</p></div>`;
            window.stop();
            throw new Error("Service stopped: Unauthorized Domain.");
        }
    };

    // 4. KEYBOARD & MOUSE PROTECTION
    const disableShortcuts = function() {
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('keydown', e => {
            if (e.keyCode === 123 || 
                (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74 || e.keyCode === 67)) || 
                (e.ctrlKey && (e.keyCode === 85 || e.keyCode === 83 || e.keyCode === 67 || e.keyCode === 65))) {
                e.preventDefault();
                return false;
            }
        });
    };

    const runProtections = function() {
        verifyIdentity();
        checkDomain();
        disableShortcuts();
    };

    if (document.readyState === 'complete') {
        runProtections();
    } else {
        window.addEventListener('load', runProtections);
    }
})();

// ============================================================================
// ENGINE WARIS UTAMA - 100% AKURAT
// ============================================================================
function hitungWaris() {
    // 1. INPUT DATA HARTA
    let hartaPribadi = parseFloat(document.getElementById('hartaPribadi').value) || 0;
    let hartaBersamaTotal = parseFloat(document.getElementById('hartaBersamaTotal').value) || 0;
    let persentasePewaris = parseFloat(document.getElementById('persentasePewaris').value) || 50;

    let kotor = hartaPribadi + (hartaBersamaTotal * (persentasePewaris / 100));
    document.getElementById('kotorTampil').innerHTML = "Rp" + Math.round(kotor).toLocaleString('id-ID', {maximumFractionDigits:0});
    
    let tahjiz = parseFloat(document.getElementById('tahjiz').value) || 0;
    let hutang = parseFloat(document.getElementById('hutang').value) || 0;
    let wasiatInput = parseFloat(document.getElementById('wasiat').value) || 0;
    
    let bersih = kotor - tahjiz - hutang;
    const wasiatMaksimal = Math.max(0, bersih / 3);
    
    let wasiatFinal = wasiatInput;
    let wasiatMsg = "";
    if (wasiatInput > wasiatMaksimal) {
        wasiatMsg = `<div class="warning">⚠️ Wasiat dikoreksi menjadi maksimal 1/3 (Rp${Math.round(wasiatMaksimal).toLocaleString('id-ID')}) sesuai Pasal 195 KHI.</div>`;
        wasiatFinal = wasiatMaksimal;
    }
    
    if (bersih < 0) {
        wasiatMsg += `<div class="warning">⚠️ Tirkah negatif (hutang+tahjiz melebihi harta). Al-irts Rp0. Wasiat tidak dijalankan.</div>`;
    }
    document.getElementById('wasiatWarning').innerHTML = wasiatMsg;
    
    let irts = Math.max(0, bersih - wasiatFinal);
    document.getElementById('irts').innerHTML = "Rp" + Math.round(irts).toLocaleString('id-ID', {maximumFractionDigits:0});

    // 2. INPUT AHLI WARIS
    const isPewarisLaki = document.getElementById('kelamin').value === 'laki';
    
    const suami = parseInt(document.getElementById('suami').value) || 0;
    const istri = parseInt(document.getElementById('istri').value) || 0;
    const anakL = parseInt(document.getElementById('anakL').value) || 0;
    const anakP = parseInt(document.getElementById('anakP').value) || 0;
    const cucuL = parseInt(document.getElementById('cucuL').value) || 0;
    const cucuP = parseInt(document.getElementById('cucuP').value) || 0;
    const ayah = parseInt(document.getElementById('ayah').value) || 0;
    const ibu = parseInt(document.getElementById('ibu').value) || 0;
    const kakek = parseInt(document.getElementById('kakek').value) || 0;
    const nenekA = parseInt(document.getElementById('nenekA').value) || 0;
    const nenekI = parseInt(document.getElementById('nenekI').value) || 0;
    const saudaraL = parseInt(document.getElementById('saudaraL').value) || 0;
    const saudaraP = parseInt(document.getElementById('saudaraP').value) || 0;
    const saudaraLSeibu = parseInt(document.getElementById('saudaraLSeibu').value) || 0;
    const saudaraPSeibu = parseInt(document.getElementById('saudaraPSeibu').value) || 0;

    const adaAnakL = anakL > 0;
    const adaAnak = anakL > 0 || anakP > 0;
    const adaCucuL = cucuL > 0;
    const adaKeturunanLaki = adaAnakL || adaCucuL;
    const adaKeturunan = adaAnak || adaCucuL || cucuP > 0;
    const adaPasangan = (suami + istri) > 0;
    const saudaraSeibuTotal = saudaraLSeibu + saudaraPSeibu;
    const saudaraKandungTotal = saudaraL + saudaraP;

    let ahli = [];
    
    function add(name, count, type, val, reason, mahjubReason=null) {
        if (count <= 0) return;
        ahli.push({
            n: name, p: count, type: type, val: val, dalil: reason,
            mahjub: !!mahjubReason, mahjubReason: mahjubReason,
            sahamDasar: 0, sahamFinal: 0, calcText: ""
        });
    }

    // === LOGIKA HIJAB & FURUDH ===

    // PASANGAN
    if (!isPewarisLaki && suami) {
        const s = adaKeturunan ? 1/4 : 1/2;
        let ket = adaKeturunan ? "karena ada keturunan" : "karena tidak ada keturunan";
        add("Suami", 1, 'fard', s, `<span class='dalil-source'>QS. 4:12 & KHI Pasal 179:</span> <span class='dalil-reason'>${toFractionString(s)} (${ket})</span>`);
    }
    if (isPewarisLaki && istri) {
        const s = adaKeturunan ? 1/8 : 1/4;
        let ket = adaKeturunan ? "karena ada keturunan" : "karena tidak ada keturunan";
        add("Istri", istri, 'fard', s/istri, `<span class='dalil-source'>QS. 4:12 & KHI Pasal 180:</span> <span class='dalil-reason'>${toFractionString(s)} (${ket})</span>`);
    }

    // GHARRAWAIN/UMARIYATAIN
    let isGharrawain = (ayah && ibu && adaPasangan && !adaKeturunan);

    // AYAH
    if (ayah) {
        if (adaKeturunanLaki) add("Ayah", 1, 'fard', 1/6, `<span class='dalil-source'>QS. 4:11 & KHI Pasal 177:</span> <span class='dalil-reason'>1/6 (karena ada anak/cucu laki-laki)</span>`);
        else if (adaKeturunan) add("Ayah", 1, 'mixed', 1/6, `<span class='dalil-source'>QS. 4:11 & KHI Pasal 177:</span> <span class='dalil-reason'>1/6 + Sisa (karena hanya ada keturunan perempuan)</span>`);
        else if (isGharrawain) add("Ayah", 1, 'ashabah', 2, `<span class='dalil-source'>Ijtihad Umar bin Khattab & KHI Bab III Pasal 177:</span> <span class='dalil-reason'>Ashabah (Mendapat sisa setelah bagian suami/istri dan ibu dalam kasus Gharrawain)</span>`);
        else add("Ayah", 1, 'ashabah', 2, `<span class='dalil-source'>QS. 4:11 & KHI Pasal 177:</span> <span class='dalil-reason'>Ashabah Bin Nafs (Menerima Sisa Seluruhnya)</span>`);
    }

    // IBU
    if (ibu) {
        const adaDuaSaudara = (saudaraL + saudaraP + saudaraLSeibu + saudaraPSeibu) >= 2;
        if (adaKeturunan || adaDuaSaudara) add("Ibu", 1, 'fard', 1/6, `<span class='dalil-source'>QS. 4:11 & KHI Pasal 178:</span> <span class='dalil-reason'>1/6 (karena ada keturunan atau ≥2 saudara)</span>`);
        else if (isGharrawain) add("Ibu", 1, 'fard_special', 0, `<span class='dalil-source'>Ijtihad Umar bin Khattab & KHI Bab III Pasal 178:</span> <span class='dalil-reason'>1/3 dari Sisa (Gharrawain/Umariyatain) agar bagian Ibu separuh dari bagian Ayah</span>`);
        else add("Ibu", 1, 'fard', 1/3, `<span class='dalil-source'>QS. 4:11 & KHI Pasal 178:</span> <span class='dalil-reason'>1/3 (karena tidak ada keturunan & saudara <2)</span>`);
    }

    // ANAK
    if (anakL) add("Anak Laki-laki", anakL, 'ashabah', 2, `<span class='dalil-source'>QS. 4:11 & KHI Pasal 176:</span> <span class='dalil-reason'>Ashabah Bin Nafs (Penerima Sisa Utama)</span>`);
    if (anakP) {
        if (anakL) add("Anak Perempuan", anakP, 'ashabah', 1, `<span class='dalil-source'>QS. 4:11 & KHI Pasal 176:</span> <span class='dalil-reason'>Ashabah Bil Ghair (Bersama Anak Laki-Laki)</span>`);
        else {
            const s = anakP === 1 ? 1/2 : 2/3;
            let ket = anakP === 1 ? "karena sendirian" : "karena dua orang atau lebih";
            add("Anak Perempuan", anakP, 'fard', s/anakP, `<span class='dalil-source'>QS. 4:11 & KHI Pasal 176:</span> <span class='dalil-reason'>${toFractionString(s)} (${ket})</span>`);
        }
    }

    // CUCU
    const mahjubCucu = adaAnakL;
    if (cucuL) {
        if (mahjubCucu) add("Cucu Laki-laki", cucuL, 'mahjub', 0, "", "Terhalang Anak Laki-laki (QS. 4:11/KHI Pasal 174 ayat 2)");
        else add("Cucu Laki-laki", cucuL, 'ashabah', 2, `<span class='dalil-source'>Ijma & KHI Pasal 185:</span> <span class='dalil-reason'>Ashabah Bin Nafs (Pengganti Anak Laki-Laki)</span>`);
    }
    if (cucuP) {
        if (mahjubCucu) add("Cucu Perempuan", cucuP, 'mahjub', 0, "", "Terhalang Anak Laki-laki (QS. 4:11/KHI Pasal 174 ayat 2)");
        else if (cucuL) add("Cucu Perempuan", cucuP, 'ashabah', 1, `<span class='dalil-source'>KHI Pasal 185:</span> <span class='dalil-reason'>Ashabah Bil Ghair (Bersama Cucu Laki-Laki)</span>`);
        else if (anakP > 1) add("Cucu Perempuan", cucuP, 'mahjub', 0, "", "Terhalang 2 Anak Perempuan (QS. 4:11/Ijma')");
        else if (anakP === 1) add("Cucu Perempuan", cucuP, 'fard', (1/6)/cucuP, `<span class='dalil-source'>QS. 4:11 (Tafsir 'Walad') & KHI Pasal 185:</span> <span class='dalil-reason'>1/6 (Pelengkap 2/3, Ahli Waris Pengganti)</span>`);
        else {
            const s = cucuP === 1 ? 1/2 : 2/3;
            let ket = cucuP === 1 ? "sendirian" : "dua orang/lebih";
            add("Cucu Perempuan", cucuP, 'fard', s/cucuP, `<span class='dalil-source'>QS. 4:11 & KHI Pasal 185:</span> <span class='dalil-reason'>${toFractionString(s)} (Ahli Waris Pengganti - ${ket})</span>`);
        }
    }

    // KAKEK
    if (kakek) {
        if (ayah) add("Kakek", 1, 'mahjub', 0, "", "Terhalang Ayah (Ijma'/KHI Pasal 174 ayat 2)");
        else if (adaKeturunanLaki) add("Kakek", 1, 'fard', 1/6, `<span class='dalil-source'>QS. 4:11 (Qiyas 'Ab'), Ijma & KHI Pasal 174:</span> <span class='dalil-reason'>1/6 (Menggantikan Ayah karena ada keturunan Laki-Laki)</span>`);
        else if (adaKeturunan) add("Kakek", 1, 'mixed', 1/6, `<span class='dalil-source'>QS. 4:11 (Qiyas 'Ab') & KHI Pasal 174:</span> <span class='dalil-reason'>1/6 + Ashabah (Menggantikan Ayah karena hanya ada keturunan Pr)</span>`);
        else add("Kakek", 1, 'ashabah', 2, `<span class='dalil-source'>QS. 4:11 (Qiyas 'Ab') & KHI Pasal 174:</span> <span class='dalil-reason'>Ashabah Bin Nafs (Menggantikan Ayah)</span>`);
    }

    // NENEK
    if (nenekI) add("Nenek (Ibu)", 1, (ibu)?'mahjub':'fard', (ibu)?0:1/6, (ibu)?"":"<span class='dalil-source'>QS. 4:11 (Analogi) & KHI Pasal 181:</span> <span class='dalil-reason'>1/6 (Hak Nenek)</span>", (ibu)?"Terhalang Ibu (KHI Pasal 174 ayat 2)":null);
    if (nenekA) {
        let block = ibu;
        add("Nenek (Ayah)", 1, block?'mahjub':'fard', block?0:1/6, block?"":"<span class='dalil-source'>QS. 4:11 (Analogi) & KHI Pasal 181:</span> <span class='dalil-reason'>1/6 (Hak Nenek)</span>", block?"Terhalang Ibu (KHI Pasal 174 ayat 2)":null);
    }
    let nenekValid = ahli.filter(x => x.n.includes("Nenek") && !x.mahjub);
    if (nenekValid.length > 1) nenekValid.forEach(n => { n.val = (1/6)/nenekValid.length; n.dalil = `<span class='dalil-source'>KHI Pasal 181:</span> <span class='dalil-reason'>Berbagi 1/6 (Nenek dari Ayah & Ibu)</span>`; });

    // === SAUDARA (LOGIKA LENGKAP - 100% AKURAT) ===
    
    const blockSaudaraFull = adaKeturunanLaki || ayah || kakek;
    const blockSeibu = adaKeturunan || ayah || kakek;
    
    // MUSYTARAKAH (KASUS KHUSUS)
    let isMusytarakah = false;
    const pasanganAda = (suami === 1 || istri > 0);
    if (pasanganAda && ibu === 1 && saudaraSeibuTotal >= 2 && saudaraKandungTotal >= 1 && !adaKeturunan && ayah === 0 && kakek === 0) {
        isMusytarakah = true;
        let totalMusytarik = saudaraSeibuTotal + saudaraKandungTotal;
        add("Saudara (Musytarakah/Saudara Kandung & Seibu)", totalMusytarik, 'fard', (1/3)/totalMusytarik, 
            `<span class='dalil-source'>QS. An-Nisā' 4:12, QS. An-Nisā' 4:176, KHI Bab III Pasal 181-182:</span>
             <span class='dalil-reason'>Saudara seibu dan sekandung berserikat dalam bagian 1/3 sesuai ketentuan musytarakah</span>`);
    }

    // SAUDARA KANDUNG/SEAYAH (PERBAIKAN LENGKAP - 100% AKURAT)
    if ((saudaraL || saudaraP) && !isMusytarakah) {
        // Cek kondisi Ashabah Ma'al Ghair
        const adaAnakPerempuanSaja = (anakP > 0 || cucuP > 0) && !adaKeturunanLaki;
        
        if (blockSaudaraFull) {
            // KONDISI 1: TERHALANG TOTAL
            add("Saudara Kandung/Seayah", saudaraKandungTotal, 'mahjub', 0, "", 
                "Terhalang Furu' Laki-laki/Ayah/Kakek (KHI Pasal 174 ayat 2)");
        } 
        else if (adaAnakPerempuanSaja) {
            // KONDISI 2: ASHABAH MA'AL GHAIR (Bersama Anak/Cucu Perempuan)
            if (saudaraL) {
                add("Saudara Laki-laki Kandung atau Seayah", saudaraL, 'ashabah', 2, 
                    `<span class='dalil-source'>QS. 4:176, HR. Bukhari (Kitab Faraid), KHI Pasal 182:</span> 
                    <span class='dalil-reason'>Ashabah Ma'al Ghair (Menjadi Ashabah BERSAMA Anak Perempuan) - Rasio 2 Porsi</span>`);
            }
            if (saudaraP) {
                add("Saudara Perempuan Kandung atau Seayah", saudaraP, 'ashabah', 1, 
                    `<span class='dalil-source'>QS. 4:176, HR. Bukhari (Kitab Faraid), KHI Pasal 182:</span> 
                    <span class='dalil-reason'>Ashabah Ma'al Ghair (Menjadi Ashabah BERSAMA Anak Perempuan) - Rasio 1 Porsi</span>`);
            }
        } 
        else {
            // KONDISI 3: WARISAN KALALAH (Tidak ada keturunan & tidak ada ayah/kakek)
            if (saudaraL) {
                add("Saudara Laki-laki Kandung atau Seayah", saudaraL, 'ashabah', 2, 
                    `<span class='dalil-source'>QS. 4:176 & KHI Pasal 182:</span> 
                    <span class='dalil-reason'>Ashabah Bin Nafs (Warisan Kalalah) - Rasio 2 Porsi</span>`);
                
                if (saudaraP) {
                    add("Saudara Perempuan Kandung atau Seayah", saudaraP, 'ashabah', 1, 
                        `<span class='dalil-source'>QS. 4:176 & KHI Pasal 182:</span> 
                        <span class='dalil-reason'>Ashabah Bil Ghair (Warisan Kalalah - Bersama Saudara Laki-laki) - Rasio 1 Porsi</span>`);
                }
            } 
            else if (saudaraP) {
                const s = saudaraP === 1 ? 1/2 : 2/3;
                let ket = saudaraP === 1 ? "sendirian" : "dua orang/lebih";
                add("Saudara Perempuan Kandung atau Seayah", saudaraP, 'fard', s/saudaraP, 
                    `<span class='dalil-source'>QS. 4:176 & KHI Pasal 182:</span> 
                    <span class='dalil-reason'>${toFractionString(s)} (Warisan Kalalah - ${ket})</span>`);
            }
        }
    }

    // SAUDARA SEIBU (100% AKURAT)
    if (saudaraSeibuTotal && !isMusytarakah) {
        if (blockSeibu) add("Saudara Seibu", saudaraSeibuTotal, 'mahjub', 0, "", "Terhalang Furu'/'Ashl Laki (KHI Pasal 174 ayat 2)");
        else {
            const s = saudaraSeibuTotal > 1 ? 1/3 : 1/6;
            let perOrg = s/saudaraSeibuTotal;
            let ket = saudaraSeibuTotal > 1 ? "dua orang/lebih" : "sendirian";
            add("Saudara Seibu", saudaraSeibuTotal, 'fard', perOrg, `<span class='dalil-source'>QS. 4:12 & KHI Pasal 181:</span> <span class='dalil-reason'>${toFractionString(s)} (${ket})</span>`);
        }
    }

    // === PERHITUNGAN MATEMATIKA (TA'SHIL & TASHIH) ===
    
    let fardhu = ahli.filter(x => (x.type === 'fard' || x.type === 'mixed' || x.type === 'fard_special') && !x.mahjub);
    let ashabah = ahli.filter(x => (x.type === 'ashabah' || x.type === 'mixed') && !x.mahjub);
    
    let denominators = fardhu.map(x => toFractionObj(x.val).d);
    let AMAwal = lcmArray(denominators);
    
    let totalPorsiAshabah = ashabah.reduce((sum, x) => {
        let val = (x.type === 'mixed') ? 2 : x.val;
        return sum + (val * x.p);
    }, 0);
    
    if (fardhu.length === 0 && ashabah.length > 0) { AMAwal = totalPorsiAshabah; }
    else if (fardhu.length === 0 && ashabah.length === 0) { AMAwal = 0; }
    if (AMAwal === 0) AMAwal = 1;

    let AMFinal = AMAwal;
    let totalSahamFardhu = 0;

    fardhu.forEach(x => {
        let frac = toFractionObj(x.val);
        x.sahamDasar = (AMAwal / frac.d) * frac.n * x.p;
        totalSahamFardhu += x.sahamDasar;
        x.sahamFinal = x.sahamDasar;
    });

    let sisa = AMAwal - totalSahamFardhu;
    let keteranganMasalah = "";

    // KOREKSI KHUSUS
    if (isGharrawain) {
        let ibuEntry = ahli.find(x => x.type === 'fard_special');
        let ayahEntry = ahli.find(x => x.n === 'Ayah');
        let pasEntry = ahli.find(x => x.n.includes('Suami') || x.n.includes('Istri'));
        
        if (pasEntry.n.includes('Suami')) { AMFinal = 6; pasEntry.sahamDasar = 3; ibuEntry.sahamDasar = 1; ayahEntry.sahamDasar = 2; AMAwal = 6; }
        else { AMFinal = 4; pasEntry.sahamDasar = 1; ibuEntry.sahamDasar = 1; ayahEntry.sahamDasar = 2; AMAwal = 4; }
        
        ibuEntry.sahamFinal = ibuEntry.sahamDasar;
        ayahEntry.sahamFinal = ayahEntry.sahamDasar;
        pasEntry.sahamFinal = pasEntry.sahamDasar;
        keteranganMasalah = "(Gharrawain)";
        sisa = 0;
    }
    else if (sisa < 0) {
        let AMAul = totalSahamFardhu;
        keteranganMasalah = `<span class="aul-text">AUL (KHI Pasal 192) (${AMAwal} → ${AMAul})</span>`;
        AMFinal = AMAul;
        sisa = 0;
    }
    else if (sisa > 0 && ashabah.length === 0) {
        let penerimaRadd = fardhu.filter(x => !x.n.includes('Suami') && !x.n.includes('Istri'));
        if (penerimaRadd.length > 0) {
            keteranganMasalah = `<span class="radd-text">RADD (KHI Pasal 193)</span>`;
            let totalSahamPenerima = penerimaRadd.reduce((a,b) => a + b.sahamDasar, 0);
            penerimaRadd.forEach(x => {
                let tambahan = (x.sahamDasar / totalSahamPenerima) * sisa;
                x.sahamFinal += tambahan;
                x.dalil += " + Radd";
            });
            sisa = 0;
        }
    }
    else {
        if (ashabah.length > 0 && sisa >= 0) {
            let totalSahamFardhuAwal = fardhu.reduce((a, b) => b.sahamDasar + a, 0);
            let sisaAwal = AMAwal - totalSahamFardhuAwal;
            
            if (sisaAwal > 0) {
                let fpb = gcd(sisaAwal, totalPorsiAshabah);
                let faktorTashih = totalPorsiAshabah / fpb;
                
                if (faktorTashih > 1) {
                    AMFinal = AMAwal * faktorTashih;
                    keteranganMasalah = `(Tashih x${faktorTashih})`;
                    fardhu.forEach(x => x.sahamFinal = x.sahamDasar * faktorTashih);
                    sisa = sisaAwal * faktorTashih;
                }
            }
            
            ashabah.forEach(x => {
                let val = (x.type === 'mixed') ? 2 : x.val;
                let porsiIndividu = val * x.p;
                let bagianAshabah = (sisa / totalPorsiAshabah) * porsiIndividu;
                
                if (x.type === 'mixed') {
                    x.sahamFinal += bagianAshabah;
                } else {
                    x.sahamFinal = bagianAshabah;
                }
                
                if (totalPorsiAshabah > 0) {
                    let commonSisaAwal = gcd(sisaAwal, AMAwal);
                    let sisaFracText = `${sisaAwal/commonSisaAwal}/${AMAwal/commonSisaAwal}`;
                    let proporsiFrac = toFractionObj(porsiIndividu / totalPorsiAshabah);
                    let proporsiText = `${proporsiFrac.n}/${proporsiFrac.d}`;
                    
                    if (fardhu.length === 0) {
                        let finalSahamFrac = toFractionObj(x.sahamFinal / AMFinal);
                        x.calcText = `<span class="rumus-text">${finalSahamFrac.n}/${finalSahamFrac.d} (Proporsi Ashabah)</span>`;
                    } else if (sisa > 0) {
                        x.calcText = `<span class="rumus-text">(${sisaFracText} sisa) x (${proporsiText} Proporsi Ashabah)</span>`;
                    }
                }
            });
        }
    }

    // === AGREGASI & VERIFIKASI ===
    
    let displayList = [];
    let seenNames = new Set();
    [...fardhu, ...ashabah].forEach(x => {
        if(!seenNames.has(x.n)) {
            displayList.push(x);
            seenNames.add(x.n);
        }
    });

    let totalSaham = displayList.reduce((sum, x) => sum + x.sahamFinal, 0);
    let totalRp = 0;
    
    displayList.forEach(x => {
        let nominal = (x.sahamFinal / AMFinal) * irts;
        totalRp += nominal;
    });

    let sisaAkhirRp = Math.max(0, irts - totalRp);
    let baitulMalAmount = 0;
    
    let nonMahjubHeirsExist = ahli.some(x => !x.mahjub);
    if (!nonMahjubHeirsExist && irts > 0) {
        baitulMalAmount = irts; totalRp = 0;
    } 
    else if (sisaAkhirRp > 500) {
        let onlySpouseLeft = displayList.length > 0 && displayList.every(x => x.n.includes("Suami") || x.n.includes("Istri"));
        if (onlySpouseLeft) { baitulMalAmount = sisaAkhirRp; }
    }
    
    // === RENDER HTML ===
    let html = `
    <h2 style="text-align:center;color:#27ae60;margin:10px 0 30px;">Hasil Pembagian Harta Warisan</h2>
    
    <div class="info" style="text-align:center;">
        Pokok Masalah (Asal Masalah Awal): <strong>${AMAwal}</strong><br>
        Saham Disempurnakan (Tashih/AUL/RADD): <strong>${AMFinal}</strong> ${keteranganMasalah}
    </div>`;

    let valid = Math.abs(irts - totalRp - baitulMalAmount) < (irts * 0.0001) || Math.abs(irts - totalRp - baitulMalAmount) < 1;
    html += `<div class="verifikasi ${valid ? 'valid' : 'error'}">
        <strong>Verifikasi Perhitungan:</strong><br>
        Total Saham Terbagi: ${Math.round(totalSaham)}/${AMFinal}
        ${baitulMalAmount > 0 ? ` (+ Sisa Baitul Mal)` : ''}<br>
        Status: <strong>${valid ? '✅ VALID - HABIS TERBAGI (Insyaallah)' : '⚠️ ADA SELISIH (Cek Pembulatan/Kasus Khusus)'}</strong>
    </div>`;

    html += `
    <table>
        <tr>
            <th width="7%">No</th>
            <th width="23%">Ahli Waris</th>
            <th>Keterangan (Dalil)</th>
            <th width="11%">Saham</th>
            <th width="19%">Jumlah (Rp)</th>
        </tr>`;

    let no = 1;
    totalRp = 0;

    displayList.forEach(x => {
        let nominal = (x.sahamFinal / AMFinal) * irts;
        totalRp += nominal;
        
        let sahamStr = `${Math.round(x.sahamFinal)}/${AMFinal}`;
        let dalilStr = x.dalil;
        
        if (x.type === 'ashabah' || x.type === 'mixed') {
             if (x.val === 2 || (x.type === 'mixed')) dalilStr += ` (Porsi 2)`;
             if (x.val === 1 && !x.n.includes("Ibu")) dalilStr += ` (Porsi 1)`;
        }
        
        if (x.calcText) dalilStr += `<br>${x.calcText}`;
        
        let rowClass = "";
        if (x.dalil.includes("Radd")) rowClass = "radd";
        if (x.dalil.includes("Ashabah") || x.type==='ashabah' || x.type==='mixed') rowClass = "ashabah";
        if (isGharrawain && (x.n === "Ibu" || x.n === "Ayah")) rowClass = "warning";

        html += `<tr class="${rowClass}">
            <td>${no++}</td>
            <td>${x.n} ${x.p > 1 && x.n != "Istri" ? `(${x.p} org)` : ''}</td>
            <td>${dalilStr}</td>
            <td>${sahamStr}</td>
            <td><strong>Rp${Math.round(nominal).toLocaleString('id-ID')}</strong></td>
        </tr>`;
    });

    // Mahjub
    let mahjubList = ahli.filter(x => x.mahjub);
    mahjubList.forEach(x => {
        html += `<tr class="mahjub">
            <td>${no++}</td>
            <td>${x.n} ${x.p > 1 ? `(${x.p} org)` : ''}</td>
            <td>${x.mahjubReason}</td>
            <td>0/${AMFinal}</td>
            <td>Rp0</td>
        </tr>`;
    });

    // Baitul Mal
    if (baitulMalAmount > 1) {
        totalRp += baitulMalAmount;
        html += `<tr class="baitul-mal-highlight">
            <td>${no++}</td>
            <td>Baitul Mal</td>
            <td style="font-size:0.9em; font-style:italic;">
                QS. An-Nisā' 4:59 (Ulil Amri), KHI Pasal 191: Bila pewaris tidak meninggalkan ahli waris sama sekali atau ahli warisnya tidak diketahui ada atau tidaknya, maka harta tersebut atas putusan Pengadilan Agama diserahkan penguasaannya kepada Baitul Mal untuk kepentingan Agama Islam dan kesejahteraan umum.
            </td>
            <td>Sisa</td>
            <td><strong>Rp${Math.round(baitulMalAmount).toLocaleString('id-ID')}</strong></td>
        </tr>`;
    }
    html += `</table>`;

    document.getElementById('hasil').innerHTML = html;
}

// === INIT ===
document.addEventListener('DOMContentLoaded', function() {
    const inputs = document.querySelectorAll('#kalkulator-waris-islam input, #kalkulator-waris-islam select');
    inputs.forEach(input => {
        input.addEventListener(input.type === 'number' ? 'input' : 'change', jadwalkanHitung);
    });
    
    document.getElementById('hartaPribadi').value = 0;
    document.getElementById('hartaBersamaTotal').value = 0;
    document.getElementById('persentasePewaris').value = 50;
    document.getElementById('tahjiz').value = 0;
    document.getElementById('hutang').value = 0;
    document.getElementById('wasiat').value = 0;
    hitungWaris();
});
</script>
</body>
</html>